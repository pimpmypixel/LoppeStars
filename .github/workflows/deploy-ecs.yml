name: Build and Deploy to ECS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest
    environment: production
    env:
      AWS_REGION: eu-central-1
      ECR_REPOSITORY: cdk-hnb659fds-container-assets-035338517878-eu-central-1
      ECR_URI: 035338517878.dkr.ecr.eu-central-1.amazonaws.com/cdk-hnb659fds-container-assets-035338517878-eu-central-1
      SOURCE_BUCKET: stall-photos
      STORAGE_BUCKET: stall-photos-processed
      IMAGE_TAG: ${{ github.sha }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build Docker image
        run: |
          docker build \
            -t ${ECR_URI}:${IMAGE_TAG} \
            --build-arg SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --build-arg SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }} \
            --build-arg SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
            --build-arg SOURCE_BUCKET=${SOURCE_BUCKET} \
            --build-arg STORAGE_BUCKET=${STORAGE_BUCKET} \
            -f Dockerfile .

      - name: Push image to ECR
        run: |
          docker push ${ECR_URI}:${IMAGE_TAG}
          echo "‚úÖ Pushed image with tag: ${IMAGE_TAG}"

      - name: Register new Task Definition
        id: register-task-def
        run: |
          cat <<EOF > task-definition.json
          {
            "family": "loppestars",
            "requiresCompatibilities": ["FARGATE"],
            "networkMode": "awsvpc",
            "cpu": "1024",
            "memory": "2048",
            "executionRoleArn": "arn:aws:iam::035338517878:role/LoppestarsEcsStack-TaskExecutionRole-RIAkMYD1kOjs",
            "taskRoleArn": "arn:aws:iam::035338517878:role/LoppestarsEcsStack-TaskRole-N7ax2UYdMxas",
            "containerDefinitions": [
              {
                "name": "web",
                "image": "${ECR_URI}:${IMAGE_TAG}",
                "cpu": 1024,
                "memory": 2048,
                "essential": true,
                "portMappings": [
                  {
                    "containerPort": 8080,
                    "hostPort": 8080,
                    "protocol": "tcp"
                  }
                ],
                "environment": [
                  {"name": "SUPABASE_URL", "value": "${{ secrets.SUPABASE_URL }}"},
                  {"name": "SUPABASE_SERVICE_ROLE_KEY", "value": "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"},
                  {"name": "SUPABASE_ANON_KEY", "value": "${{ secrets.SUPABASE_ANON_KEY }}"},
                  {"name": "SOURCE_BUCKET", "value": "${SOURCE_BUCKET}"},
                  {"name": "STORAGE_BUCKET", "value": "${STORAGE_BUCKET}"}
                ],
                "logConfiguration": {
                  "logDriver": "awslogs",
                  "options": {
                    "awslogs-group": "LoppestarsEcsStack-ServiceTaskDefwebLogGroup2A898F61-l6JeWYmfnmS5",
                    "awslogs-region": "${AWS_REGION}",
                    "awslogs-stream-prefix": "Service"
                  }
                }
              }
            ]
          }
          EOF
          
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://task-definition.json \
            --region ${AWS_REGION} \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo "task_definition_arn=${TASK_DEF_ARN}" >> $GITHUB_OUTPUT
          echo "‚úÖ Registered task definition: ${TASK_DEF_ARN}"

      - name: Update ECS Service
        run: |
          echo "üöÄ Updating ECS service..."
          
          CLUSTER=$(aws ecs list-clusters \
            --region ${AWS_REGION} \
            --query "clusterArns[0]" \
            --output text | awk -F/ '{print $NF}')
          
          if [ -z "$CLUSTER" ] || [ "$CLUSTER" = "None" ]; then
            echo "‚ùå ERROR: Could not find ECS cluster"
            exit 1
          fi
          
          SERVICE=$(aws ecs list-services \
            --cluster $CLUSTER \
            --region ${AWS_REGION} \
            --query "serviceArns[0]" \
            --output text | awk -F/ '{print $NF}')
          
          if [ -z "$SERVICE" ] || [ "$SERVICE" = "None" ]; then
            echo "‚ùå ERROR: Could not find ECS service in cluster $CLUSTER"
            exit 1
          fi
          
          echo "üì¶ Cluster: $CLUSTER"
          echo "üîß Service: $SERVICE"
          echo "ÔøΩÔøΩÔ∏è  Task Definition: ${{ steps.register-task-def.outputs.task_definition_arn }}"
          
          aws ecs update-service \
            --cluster $CLUSTER \
            --service $SERVICE \
            --task-definition ${{ steps.register-task-def.outputs.task_definition_arn }} \
            --force-new-deployment \
            --region ${AWS_REGION} \
            --output json > /dev/null
          
          echo "‚úÖ Service update initiated"

      - name: Wait for Deployment
        run: |
          echo "‚è≥ Waiting for deployment to stabilize..."
          
          CLUSTER=$(aws ecs list-clusters \
            --region ${AWS_REGION} \
            --query "clusterArns[0]" \
            --output text | awk -F/ '{print $NF}')
          
          SERVICE=$(aws ecs list-services \
            --cluster $CLUSTER \
            --region ${AWS_REGION} \
            --query "serviceArns[0]" \
            --output text | awk -F/ '{print $NF}')
          
          echo "üì¶ Cluster: $CLUSTER"
          echo "üîß Service: $SERVICE"
          echo ""
          echo "Polling deployment status (max 10 minutes)..."
          
          # Custom wait loop with timeout and better error handling
          MAX_ATTEMPTS=40  # 40 attempts √ó 15 seconds = 10 minutes
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            # Get deployment status
            DEPLOYMENT_STATUS=$(aws ecs describe-services \
              --cluster $CLUSTER \
              --services $SERVICE \
              --region ${AWS_REGION} \
              --query 'services[0].deployments[?status==`PRIMARY`].{RolloutState:rolloutState,Running:runningCount,Desired:desiredCount,Failed:failedTasks}' \
              --output json)
            
            ROLLOUT_STATE=$(echo $DEPLOYMENT_STATUS | jq -r '.[0].RolloutState')
            RUNNING_COUNT=$(echo $DEPLOYMENT_STATUS | jq -r '.[0].Running')
            DESIRED_COUNT=$(echo $DEPLOYMENT_STATUS | jq -r '.[0].Desired')
            FAILED_TASKS=$(echo $DEPLOYMENT_STATUS | jq -r '.[0].Failed')
            
            echo "  Rollout: $ROLLOUT_STATE | Running: $RUNNING_COUNT/$DESIRED_COUNT | Failed: $FAILED_TASKS"
            
            # Check for completion
            if [ "$ROLLOUT_STATE" = "COMPLETED" ]; then
              echo ""
              echo "‚úÖ Deployment completed successfully!"
              break
            fi
            
            # Check for failures
            if [ "$FAILED_TASKS" -gt 0 ]; then
              echo ""
              echo "‚ö†Ô∏è  WARNING: $FAILED_TASKS task(s) failed during deployment"
              echo "Checking for recent task failures..."
              
              STOPPED_TASKS=$(aws ecs list-tasks \
                --cluster $CLUSTER \
                --service-name $SERVICE \
                --desired-status STOPPED \
                --region ${AWS_REGION} \
                --query 'taskArns[0]' \
                --output text)
              
              if [ "$STOPPED_TASKS" != "None" ] && [ -n "$STOPPED_TASKS" ]; then
                echo "Last stopped task: $STOPPED_TASKS"
                aws ecs describe-tasks \
                  --cluster $CLUSTER \
                  --tasks $STOPPED_TASKS \
                  --region ${AWS_REGION} \
                  --query 'tasks[0].{StoppedReason:stoppedReason,ExitCode:containers[0].exitCode}' \
                  --output json
              fi
            fi
            
            # Check if stuck with no progress
            if [ "$RUNNING_COUNT" -eq 0 ] && [ $ATTEMPT -gt 10 ]; then
              echo ""
              echo "‚ùå ERROR: Deployment stuck - no tasks running after ${ATTEMPT} attempts"
              echo "This usually indicates health check failures or resource constraints"
              exit 1
            fi
            
            # Wait before next check
            sleep 15
          done
          
          if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
            echo ""
            echo "‚ùå ERROR: Deployment did not stabilize within 10 minutes"
            exit 1
          fi

      - name: Verify Deployment
        run: |
          echo "üîç Verifying deployment..."
          
          CLUSTER=$(aws ecs list-clusters \
            --region ${AWS_REGION} \
            --query "clusterArns[0]" \
            --output text | awk -F/ '{print $NF}')
          
          SERVICE=$(aws ecs list-services \
            --cluster $CLUSTER \
            --region ${AWS_REGION} \
            --query "serviceArns[0]" \
            --output text | awk -F/ '{print $NF}')
          
          TASK_ARN=$(aws ecs list-tasks \
            --cluster $CLUSTER \
            --service-name $SERVICE \
            --desired-status RUNNING \
            --region ${AWS_REGION} \
            --query 'taskArns[0]' \
            --output text)
          
          if [ -z "$TASK_ARN" ] || [ "$TASK_ARN" = "None" ]; then
            echo "‚ö†Ô∏è  WARNING: No running tasks found"
            exit 1
          fi
          
          TASK_DETAILS=$(aws ecs describe-tasks \
            --cluster $CLUSTER \
            --tasks $TASK_ARN \
            --region ${AWS_REGION} \
            --query 'tasks[0]' \
            --output json)
          
          RUNNING_IMAGE=$(echo $TASK_DETAILS | jq -r '.containers[0].image')
          TASK_DEF_ARN=$(echo $TASK_DETAILS | jq -r '.taskDefinitionArn')
          
          echo "üèÉ Running image: ${RUNNING_IMAGE}"
          echo "üìã Task definition: ${TASK_DEF_ARN}"
          
          # Check if the running image matches our expected image tag
          EXPECTED_IMAGE="${ECR_URI}:${IMAGE_TAG}"
          
          # Extract digest from ECR for the pushed image
          LATEST_DIGEST=$(aws ecr describe-images \
            --repository-name ${ECR_REPOSITORY} \
            --image-ids imageTag=${IMAGE_TAG} \
            --region ${AWS_REGION} \
            --query 'imageDetails[0].imageDigest' \
            --output text)
          
          echo "üì¶ Latest digest: ${LATEST_DIGEST}"
          
          # Check if running image contains our commit SHA tag OR matches the digest
          if echo "$RUNNING_IMAGE" | grep -q "$IMAGE_TAG"; then
            echo ""
            echo "============================================================"
            echo "‚úÖ SUCCESS: Latest changes are LIVE!"
            echo "============================================================"
            echo "Cluster: $CLUSTER"
            echo "Service: $SERVICE"
            echo "Task Definition: ${{ steps.register-task-def.outputs.task_definition_arn }}"
            echo "Image Tag: ${IMAGE_TAG}"
            echo "Image Digest: ${LATEST_DIGEST}"
            echo "Running Image: ${RUNNING_IMAGE}"
            echo "============================================================"
          elif echo "$RUNNING_IMAGE" | grep -q "$LATEST_DIGEST"; then
            echo ""
            echo "============================================================"
            echo "‚úÖ SUCCESS: Latest changes are LIVE (digest match)!"
            echo "============================================================"
            echo "Cluster: $CLUSTER"
            echo "Service: $SERVICE"
            echo "Image Digest: ${LATEST_DIGEST}"
            echo "Running Image: ${RUNNING_IMAGE}"
            echo "============================================================"
          else
            echo ""
            echo "============================================================"
            echo "‚ö†Ô∏è  WARNING: Deployment verification failed"
            echo "============================================================"
            echo "Expected tag: ${IMAGE_TAG}"
            echo "Expected digest: ${LATEST_DIGEST}"
            echo "Running image: ${RUNNING_IMAGE}"
            echo "============================================================"
            echo ""
            echo "This may indicate the service is still using an old task."
            echo "Please check the ECS console or wait a few more minutes."
            exit 1
          fi
